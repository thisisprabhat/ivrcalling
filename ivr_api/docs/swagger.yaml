openapi: 3.0.0
info:
  title: IVR Calling System API
  description: |
    A comprehensive IVR (Interactive Voice Response) calling system for marketing campaigns with multilanguage support.

    ## Features
    - Campaign management (CRUD operations)
    - Bulk call initiation with Twilio integration
    - Multi-language support (English, Spanish, French, German, Hindi)
    - Real-time call status tracking
    - IVR menu navigation with user input handling
    - Opt-out management

    ## Authentication
    Currently, the API is open. For production, implement JWT or API key authentication.

    ## Rate Limiting
    Not implemented. Recommended for production use.
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Development server
  - url: https://api.yourcompany.com
    description: Production server

tags:
  - name: Health
    description: System health and status endpoints
  - name: Languages
    description: Language support information
  - name: Campaigns
    description: Campaign management operations
  - name: Calls
    description: Call initiation and status tracking
  - name: Webhooks
    description: Twilio webhook endpoints (internal use)

paths:
  /api/health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns the health status of the service
      operationId: healthCheck
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  service:
                    type: string
                    example: IVR Calling System

  /api/languages:
    get:
      tags:
        - Languages
      summary: Get supported languages
      description: Returns a list of all supported languages for IVR calls
      operationId: getSupportedLanguages
      responses:
        "200":
          description: List of supported languages
          content:
            application/json:
              schema:
                type: object
                properties:
                  languages:
                    type: array
                    items:
                      type: object
                      properties:
                        code:
                          type: string
                          example: en
                        name:
                          type: string
                          example: English

  /api/campaigns:
    get:
      tags:
        - Campaigns
      summary: List all campaigns
      description: Retrieves all marketing campaigns
      operationId: listCampaigns
      responses:
        "200":
          description: List of campaigns
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Campaign"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    post:
      tags:
        - Campaigns
      summary: Create a new campaign
      description: Creates a new marketing campaign
      operationId: createCampaign
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - description
              properties:
                name:
                  type: string
                  example: Summer Sale 2024
                description:
                  type: string
                  example: Promotional campaign for summer products
                language:
                  type: string
                  example: en
                  default: en
                is_active:
                  type: boolean
                  example: true
                  default: true
      responses:
        "201":
          description: Campaign created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Campaign"
        "400":
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/campaigns/{id}:
    get:
      tags:
        - Campaigns
      summary: Get campaign by ID
      description: Retrieves a specific campaign by its ID
      operationId: getCampaign
      parameters:
        - name: id
          in: path
          required: true
          description: Campaign ID (MongoDB ObjectID)
          schema:
            type: string
            example: 507f1f77bcf86cd799439011
      responses:
        "200":
          description: Campaign details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Campaign"
        "400":
          description: Invalid campaign ID
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Campaign not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    put:
      tags:
        - Campaigns
      summary: Update campaign
      description: Updates an existing campaign
      operationId: updateCampaign
      parameters:
        - name: id
          in: path
          required: true
          description: Campaign ID (MongoDB ObjectID)
          schema:
            type: string
            example: 507f1f77bcf86cd799439011
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: Updated Campaign Name
                description:
                  type: string
                  example: Updated description
                language:
                  type: string
                  example: es
                is_active:
                  type: boolean
                  example: false
      responses:
        "200":
          description: Campaign updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Campaign"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Campaign not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      tags:
        - Campaigns
      summary: Delete campaign
      description: Deletes a campaign by ID
      operationId: deleteCampaign
      parameters:
        - name: id
          in: path
          required: true
          description: Campaign ID (MongoDB ObjectID)
          schema:
            type: string
            example: 507f1f77bcf86cd799439011
      responses:
        "200":
          description: Campaign deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Campaign deleted successfully
        "400":
          description: Invalid campaign ID
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Campaign not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/campaigns/{id}/calls:
    get:
      tags:
        - Campaigns
      summary: Get campaign calls
      description: Retrieves all calls associated with a specific campaign and statistics
      operationId: getCampaignCalls
      parameters:
        - name: id
          in: path
          required: true
          description: Campaign ID (MongoDB ObjectID)
          schema:
            type: string
            example: 507f1f77bcf86cd799439011
      responses:
        "200":
          description: Campaign calls and statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  calls:
                    type: array
                    items:
                      $ref: "#/components/schemas/Call"
                  statistics:
                    type: object
                    properties:
                      total:
                        type: integer
                        example: 100
                      pending:
                        type: integer
                        example: 10
                      initiated:
                        type: integer
                        example: 30
                      completed:
                        type: integer
                        example: 50
                      failed:
                        type: integer
                        example: 10
        "400":
          description: Invalid campaign ID
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/calls/bulk:
    post:
      tags:
        - Calls
      summary: Initiate bulk calls
      description: |
        Initiates multiple calls for a specific campaign. This endpoint:
        - Validates the campaign exists and is active
        - Creates call records for each contact
        - Initiates calls via Twilio
        - Returns call IDs for tracking
      operationId: initiateBulkCalls
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - campaign_id
                - contacts
              properties:
                campaign_id:
                  type: string
                  description: MongoDB ObjectID of the campaign
                  example: 507f1f77bcf86cd799439011
                language:
                  type: string
                  description: Override campaign language (optional)
                  example: es
                contacts:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required:
                      - phone_number
                      - name
                    properties:
                      phone_number:
                        type: string
                        description: Phone number in E.164 format
                        example: "+1234567890"
                      name:
                        type: string
                        description: Customer name
                        example: John Doe
            examples:
              single_contact:
                summary: Single contact
                value:
                  campaign_id: "507f1f77bcf86cd799439011"
                  contacts:
                    - phone_number: "+1234567890"
                      name: "John Doe"
              multiple_contacts:
                summary: Multiple contacts with language override
                value:
                  campaign_id: "507f1f77bcf86cd799439011"
                  language: "es"
                  contacts:
                    - phone_number: "+1234567890"
                      name: "John Doe"
                    - phone_number: "+0987654321"
                      name: "Jane Smith"
      responses:
        "200":
          description: Calls initiated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Bulk calls initiated
                  total:
                    type: integer
                    example: 2
                  successful:
                    type: integer
                    example: 2
                  failed:
                    type: integer
                    example: 0
                  call_ids:
                    type: array
                    items:
                      type: string
                      example: 507f1f77bcf86cd799439012
        "400":
          description: Invalid request (campaign not found, inactive campaign, or validation error)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/calls/{id}:
    get:
      tags:
        - Calls
      summary: Get call status
      description: Retrieves the status and logs of a specific call
      operationId: getCallStatus
      parameters:
        - name: id
          in: path
          required: true
          description: Call ID (MongoDB ObjectID)
          schema:
            type: string
            example: 507f1f77bcf86cd799439012
      responses:
        "200":
          description: Call details with logs
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Call"
                  - type: object
                    properties:
                      logs:
                        type: array
                        items:
                          $ref: "#/components/schemas/CallLog"
        "400":
          description: Invalid call ID
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Call not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/webhook/voice:
    post:
      tags:
        - Webhooks
      summary: Voice webhook (Twilio callback)
      description: |
        Internal endpoint called by Twilio when a call is answered.
        Generates TwiML response with personalized welcome message.

        **Note:** This endpoint is called by Twilio, not by end users.
      operationId: handleVoiceWebhook
      parameters:
        - name: language
          in: query
          schema:
            type: string
            example: en
        - name: call_id
          in: query
          schema:
            type: string
            example: 507f1f77bcf86cd799439012
      responses:
        "200":
          description: TwiML response
          content:
            application/xml:
              schema:
                type: string
                example: |
                  <?xml version="1.0" encoding="UTF-8"?>
                  <Response>
                    <Say voice="alice" language="en-US">Hello John, welcome to our service...</Say>
                    <Gather action="/api/webhook/gather" numDigits="1">
                      <Say>Press 1 for product information...</Say>
                    </Gather>
                  </Response>

  /api/webhook/gather:
    post:
      tags:
        - Webhooks
      summary: Gather webhook (user input handling)
      description: |
        Internal endpoint called by Twilio when user presses a key.
        Handles menu navigation based on user input.

        **Menu Options:**
        - 1: Product information
        - 2: Special offers
        - 3: Opt-out from calls
        - 0: Return to main menu
        - 9: Repeat current menu
      operationId: handleGatherWebhook
      responses:
        "200":
          description: TwiML response based on user input

  /api/webhook/status:
    post:
      tags:
        - Webhooks
      summary: Status callback webhook
      description: |
        Internal endpoint called by Twilio to update call status.
        Handles status changes: queued, ringing, in-progress, completed, failed, etc.
      operationId: handleStatusWebhook
      responses:
        "200":
          description: Status updated

  /api/webhook/optout:
    post:
      tags:
        - Webhooks
      summary: Opt-out confirmation webhook
      description: |
        Internal endpoint called by Twilio when user confirms opt-out.
        Processes the opt-out request and logs it.
      operationId: handleOptOutConfirm
      responses:
        "200":
          description: Opt-out processed

components:
  schemas:
    Campaign:
      type: object
      properties:
        _id:
          type: string
          description: MongoDB ObjectID
          example: 507f1f77bcf86cd799439011
        name:
          type: string
          example: Summer Sale 2024
        description:
          type: string
          example: Promotional campaign for summer products
        language:
          type: string
          example: en
          enum: [en, es, fr, de, hi]
        is_active:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"

    Call:
      type: object
      properties:
        _id:
          type: string
          description: MongoDB ObjectID
          example: 507f1f77bcf86cd799439012
        campaign_id:
          type: string
          description: Reference to campaign ObjectID
          example: 507f1f77bcf86cd799439011
        phone_number:
          type: string
          example: "+1234567890"
        customer_name:
          type: string
          example: John Doe
        status:
          type: string
          enum: [pending, initiated, in-progress, completed, failed]
          example: completed
        twilio_call_sid:
          type: string
          description: Twilio's unique call identifier
          example: CA1234567890abcdef1234567890abcdef
        language:
          type: string
          example: en
        duration:
          type: integer
          description: Call duration in seconds
          example: 45
        error_message:
          type: string
          nullable: true
          example: null
        created_at:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2024-01-15T10:35:00Z"

    CallLog:
      type: object
      properties:
        _id:
          type: string
          description: MongoDB ObjectID
          example: 507f1f77bcf86cd799439013
        call_id:
          type: string
          description: Reference to call ObjectID
          example: 507f1f77bcf86cd799439012
        event:
          type: string
          example: user_input
        details:
          type: string
          example: User selected option 1 - Product Information
        user_input:
          type: string
          nullable: true
          example: "1"
        created_at:
          type: string
          format: date-time
          example: "2024-01-15T10:32:00Z"

    Error:
      type: object
      properties:
        error:
          type: string
          example: Invalid request
        message:
          type: string
          example: Campaign ID is required

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication (not currently implemented)
# Security is currently not enabled but can be added
# security:
#   - ApiKeyAuth: []
